<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Roadrage — Route Planner</title>

<!-- =========================================================
FILE: web/index.html
FULL DROP-IN (PRESERVED FEATURES + MAP-FIRST REDESIGN + MODE BOXES)
Requires: web/assets/vehicles-hero.png
========================================================= -->

<!-- Leaflet (map) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<style>
  :root{
    color-scheme: dark;
    --text: #e6edf7;
    --muted: #a8b3c7;
    --muted2: rgba(168,179,199,0.78);
    --line: rgba(255,255,255,0.14);
    --line2: rgba(255,255,255,0.10);
    --glassA: rgba(18,24,36,0.62);
    --glassB: rgba(10,14,22,0.52);
    --panel: rgba(0,0,0,0.35);

    --blue: #3b82f6;
    --blue2:#2563eb;
    --ok: #22c55e;
    --bad:#ef4444;
    --warn:#f59e0b;
  }

  /* =========================================================
     BACKGROUND
  ========================================================= */
  body{
    margin:0;
    min-height:100vh;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color: var(--text);

    background:
      linear-gradient(rgba(8,10,16,0.78), rgba(8,10,16,0.94)),
      url("./assets/vehicles-hero.png") center top / cover no-repeat fixed;
  }

  /* =========================================================
     WRAP + HEADER
  ========================================================= */
  .wrap{
    max-width: 1350px;
    margin: 0 auto;
    padding: 26px 16px 56px;
  }

  .topbar{
    display:flex;
    justify-content: space-between;
    align-items: end;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 14px;
  }

  h1{
    margin:0;
    font-size: 34px;
    letter-spacing: 0.2px;
  }

  .sub{
    margin-top: 6px;
    color: var(--muted);
    font-size: 13px;
  }

  .pill{
    display:inline-block;
    padding: 4px 10px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.07);
    border-radius: 999px;
    font-size: 12px;
    color: var(--text);
    max-width: 700px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
  }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
  }

  /* =========================================================
     GRID (MAP FIRST)
  ========================================================= */
  .grid{
    display:grid;
    grid-template-columns: 1fr 440px;
    gap: 16px;
    align-items: start;
  }

  @media (max-width: 1100px){
    .grid{ grid-template-columns: 1fr; }
  }

  /* =========================================================
     CARDS
  ========================================================= */
  .card{
    border: 1px solid var(--line);
    border-radius: 18px;
    background: linear-gradient(180deg, var(--glassA), rgba(0,0,0,0.30));
    backdrop-filter: blur(12px);
    box-shadow: 0 22px 56px rgba(0,0,0,0.38);
    overflow: hidden;
  }

  .cardHead{
    padding: 14px 16px 12px;
    border-bottom: 1px solid var(--line);
    display:flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .cardTitle{
    font-size: 13px;
    color: var(--muted);
    letter-spacing: .2px;
  }

  .cardBody{
    padding: 14px 16px 16px;
  }

  .hr{
    height: 1px;
    background: var(--line);
    margin: 14px 0;
  }

  /* =========================================================
     SUMMARY STRIP
  ========================================================= */
  .summaryRow{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    margin-bottom: 12px;
  }
  @media (max-width: 980px){
    .summaryRow{ grid-template-columns: repeat(2, 1fr); }
  }
  .summaryCard{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.06);
    border-radius: 14px;
    padding: 10px 12px;
    min-height: 54px;
  }
  .summaryCard .k{ color: var(--muted); font-size: 12px; }
  .summaryCard .v{ color: var(--text); font-size: 18px; font-weight: 780; margin-top: 2px; }

  /* =========================================================
     MAP
  ========================================================= */
  #map{
    height: 560px;
    border-radius: 14px;
    border: 1px solid var(--line);
    overflow: hidden;
    background: rgba(0,0,0,0.35);
  }

  /* =========================================================
     CONTROLS
  ========================================================= */
  .row{
    display:flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: end;
  }

  label{
    display:flex;
    flex-direction: column;
    gap: 6px;
    font-size: 12px;
    color: var(--muted);
  }

  input, select, button, textarea{
    font: inherit;
    border-radius: 10px;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.06);
    color: var(--text);
    padding: 10px 12px;
    outline: none;
  }

  input::placeholder, textarea::placeholder{ color: rgba(168,179,199,0.75); }

  button{
    cursor:pointer;
    border: none;
    background: linear-gradient(135deg, var(--blue2), var(--blue));
    font-weight: 650;
    padding: 11px 14px;
  }

  button:disabled{
    opacity: 0.55;
    cursor: not-allowed;
  }

  .btnGhost{
    background: rgba(255,255,255,0.08);
    border: 1px solid var(--line);
    color: var(--text);
    font-weight: 600;
  }

  .btnTiny{
    padding: 8px 10px;
    font-size: 12px;
    border-radius: 10px;
  }

  /* =========================================================
     PRESETS (MODES)
  ========================================================= */
  .presetBar{
    display:flex;
    flex-wrap:wrap;
    gap: 10px;
    align-items:center;
  }

  .preset{
    display:flex;
    gap: 8px;
    align-items:center;
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.07);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 12px;
    cursor: pointer;
    user-select: none;
    transition: transform 0.06s ease;
  }
  .preset:active{ transform: translateY(1px); }

  .preset.active{
    border-color: rgba(59,130,246,0.65);
    box-shadow: 0 0 0 2px rgba(59,130,246,0.22) inset;
  }

  .preset b{ font-size: 13px; }
  .preset span{ font-size: 12px; color: var(--muted); }

  /* =========================================================
     MODE OPTIONS BOX (NEW)
  ========================================================= */
  .modeBox{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.06);
    border-radius: 14px;
    padding: 12px;
  }
  .modeBoxTitle{
    display:flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 10px;
  }
  .modeBoxTitle b{ font-size: 13px; }
  .modeBoxTitle span{ font-size: 12px; color: var(--muted); }

  .modeGrid2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 520px){
    .modeGrid2{ grid-template-columns: 1fr; }
  }

  .hint{
    font-size: 12px;
    color: var(--muted);
    margin-top: 8px;
  }

  /* =========================================================
     ADVANCED TOGGLE
  ========================================================= */
  .advToggle{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
    width: 100%;
    cursor:pointer;
    user-select:none;
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: rgba(255,255,255,0.06);
  }

  .advToggle .left{
    display:flex;
    flex-direction: column;
    gap: 2px;
  }

  .advToggle .left .t{
    color: var(--text);
    font-size: 13px;
    font-weight: 650;
  }

  .advToggle .left .d{
    color: var(--muted);
    font-size: 12px;
  }

  .adv{
    display:none;
    margin-top: 12px;
  }
  .adv.open{ display:block; }

  /* =========================================================
     STATUS
  ========================================================= */
  .status{
    font-size: 12px;
    color: var(--muted);
  }
  .status .ok{ color: var(--ok); font-weight: 750; }
  .status .bad{ color: var(--bad); font-weight: 750; }
  .status .warn{ color: var(--warn); font-weight: 750; }

  /* =========================================================
     AUTOCOMPLETE DROPDOWN
  ========================================================= */
  .suggest{
    position:absolute;
    left: 0;
    right: 0;
    top: calc(100% + 6px);
    z-index: 9999;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: rgba(10,14,22,0.98);
    backdrop-filter: blur(10px);
    overflow: hidden;
    box-shadow: 0 18px 50px rgba(0,0,0,0.45);
  }

  .suggestItem{
    padding: 10px 12px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text);
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .suggestItem:first-child{ border-top: none; }

  .suggestItem:hover,
  .suggestItem.active{
    background: rgba(59,130,246,0.18);
  }

  .suggestSmall{
    display:block;
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .suggestLoading{
    padding: 10px 12px;
    font-size: 13px;
    color: var(--muted);
  }

  /* =========================================================
     DEBUG + HISTORY
  ========================================================= */
  pre{
    margin: 0;
    padding: 12px;
    border-radius: 14px;
    background: rgba(0,0,0,0.55);
    border: 1px solid var(--line);
    overflow:auto;
    white-space: pre-wrap;
    word-break: break-word;
  }

  .kv{
    display:grid;
    grid-template-columns: 130px 1fr;
    gap: 8px 10px;
    align-items: start;
    font-size: 12px;
    color: var(--muted);
  }
  .kv b{ color: var(--text); font-weight: 650; }

  .history{
    display:flex;
    flex-direction: column;
    gap: 10px;
  }

  .hItem{
    border: 1px solid var(--line);
    background: rgba(255,255,255,0.05);
    border-radius: 14px;
    padding: 10px 12px;
  }

  .hTop{
    display:flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 6px;
  }

  .hTop b{ font-size: 13px; }
  .hTop span{ font-size: 12px; color: var(--muted); }

  .hMeta{
    display:flex;
    flex-wrap: wrap;
    gap: 8px;
    color: var(--muted);
    font-size: 12px;
  }

  /* =========================================================
     RIGHT PANEL TABS
  ========================================================= */
  .tabs{
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .tabBtn{
    padding: 8px 10px;
    font-size: 12px;
    border-radius: 10px;
  }

  .tabBtn.active{
    box-shadow: 0 0 0 2px rgba(59,130,246,0.22) inset;
    border: 1px solid rgba(59,130,246,0.55);
  }

  .tabPanel{ display:none; }
  .tabPanel.active{ display:block; }

  a { color: #9ec2ff; text-decoration: none; }
  a:hover { text-decoration: underline; }
</style>
</head>

<body>
  <div class="wrap">

    <div class="topbar">
      <div>
        <h1>Roadrage — Route Planner</h1>
        <div class="sub">
          API base: <span class="pill mono" id="apiBasePill">…</span>
          <span class="mono">/v1/route/plan</span>
        </div>
      </div>

      <div class="sub">
        Override:
        <span class="pill mono">?api=https://your-api.example.com</span>
      </div>
    </div>

    <div class="grid">
      <!-- =========================================================
           LEFT: MAP + SUMMARY
      ========================================================= -->
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">Route</div>
          <div class="status mono" id="status">Ready</div>
        </div>

        <div class="cardBody">
          <div class="summaryRow">
            <div class="summaryCard">
              <div class="k">ETA</div>
              <div class="v" id="mEta">—</div>
            </div>
            <div class="summaryCard">
              <div class="k">Distance</div>
              <div class="v" id="mDist">—</div>
            </div>
            <div class="summaryCard">
              <div class="k">Stress</div>
              <div class="v" id="mStress">—</div>
            </div>
            <div class="summaryCard">
              <div class="k">Tow Risk</div>
              <div class="v" id="mTow">—</div>
            </div>
          </div>

          <div id="map"></div>

          <div class="sub" style="margin-top:10px;">
            Address lookup uses OpenStreetMap Nominatim. Pick a suggestion to lock coordinates.
          </div>
        </div>
      </div>

      <!-- =========================================================
           RIGHT: CONTROLS / HISTORY / DEVELOPER
      ========================================================= -->
      <div class="card">
        <div class="cardHead">
          <div class="cardTitle">Controls</div>
          <div class="tabs">
            <button class="btnGhost tabBtn active" id="tabControlsBtn" type="button">Controls</button>
            <button class="btnGhost tabBtn" id="tabHistoryBtn" type="button">History</button>
            <button class="btnGhost tabBtn" id="tabDevBtn" type="button">Developer</button>
          </div>
        </div>

        <div class="cardBody">

          <!-- ===================== TAB: CONTROLS ===================== -->
          <div class="tabPanel active" id="tabControls">

            <!-- =========================================================
                 SECTION: MODES (CLICKABLE)
                 (Existing preset tiles preserved; now they drive Mode Options box below)
            ========================================================= -->
            <div class="presetBar" id="presetBar">
              <div class="preset active" data-preset="TOW">
                <div>
                  <b>Tow</b><br><span>Trailer-aware routing</span>
                </div>
              </div>
              <div class="preset" data-preset="LOW_STRESS">
                <div>
                  <b>Low Stress</b><br><span>Comfort prioritized</span>
                </div>
              </div>
              <div class="preset" data-preset="FUEL_SAVER">
                <div>
                  <b>Fuel Saver</b><br><span>Efficiency prioritized</span>
                </div>
              </div>
              <div class="preset" data-preset="FASTEST">
                <div>
                  <b>Fastest</b><br><span>Time prioritized</span>
                </div>
              </div>
            </div>

            <!-- =========================================================
                 SECTION: MODE OPTIONS BOX (NEW)
                 Shows different content based on selected mode.
            ========================================================= -->
            <div style="margin-top: 12px;">
              <!-- Tow Options -->
              <div class="modeBox" id="modeBoxTow" hidden>
                <div class="modeBoxTitle">
                  <b>Tow options</b>
                  <span class="mono">Sets trailerLengthFt automatically</span>
                </div>

                <div class="modeGrid2">
                  <label>
                    Tow vehicle
                    <select id="towVehicleClass">
                      <option value="SMART_CAR">Smart car / Micro</option>
                      <option value="MID_SIZE_SEDAN">Mid-size sedan</option>
                      <option value="SMALL_SUV">Small SUV / Crossover</option>
                      <option value="LARGE_SUV">Large SUV</option>
                      <option value="CREW_CAB_LONG_BED" selected>Crew cab long bed truck</option>
                      <option value="SEMI_TRACTOR">Semi tractor</option>
                    </select>
                  </label>

                  <label>
                    Trailer setup
                    <select id="towTrailerPreset">
                      <option value="NONE|0">None (0 ft)</option>
                      <option value="SMALL_UTILITY|12">Truck + small trailer (12 ft)</option>
                      <option value="CAR_HAULER|20">Truck + car hauler (20 ft)</option>
                      <option value="FIFTH_WHEEL|35">Truck + fifth wheel camper (35 ft)</option>
                      <option value="SEMI_TRAILER|53">Semi + trailer (53 ft)</option>
                    </select>
                  </label>
                </div>

                <div class="hint">
                  Your manual <span class="pill mono">Trailer length (ft)</span> field stays available; this just fills it for you.
                </div>
              </div>

              <!-- Low Stress Options -->
              <div class="modeBox" id="modeBoxLowStress" hidden>
                <div class="modeBoxTitle">
                  <b>Low stress options</b>
                  <span class="mono">Comfort + simplicity preferences</span>
                </div>

                <div class="modeGrid2">
                  <label>
                    Driving style
                    <select id="lsDrivingStyle">
                      <option value="CALM" selected>Calm</option>
                      <option value="NORMAL">Normal</option>
                      <option value="ASSERTIVE">Assertive</option>
                    </select>
                  </label>

                  <label>
                    Prefer simpler driving
                    <select id="lsSimplicity">
                      <option value="HIGH" selected>High (avoid complexity)</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="LOW">Low</option>
                    </select>
                  </label>
                </div>

                <div class="modeGrid2" style="margin-top:10px;">
                  <label>
                    Prefer fewer merges
                    <select id="lsPreferFewerMerges">
                      <option value="true" selected>true</option>
                      <option value="false">false</option>
                    </select>
                  </label>

                  <label>
                    Prefer right lane
                    <select id="lsPreferRightLane">
                      <option value="true" selected>true</option>
                      <option value="false">false</option>
                    </select>
                  </label>

                  <label>
                    Avoid left turns
                    <select id="lsAvoidLeftTurns">
                      <option value="false" selected>false</option>
                      <option value="true">true</option>
                    </select>
                  </label>

                  <label>
                    Avoid complex interchanges
                    <select id="lsAvoidComplexInterchanges">
                      <option value="true" selected>true</option>
                      <option value="false">false</option>
                    </select>
                  </label>
                </div>

                <div class="hint">
                  These are additive preferences. Your existing Advanced toggles still apply.
                </div>
              </div>

              <!-- Fuel Saver / Fastest: no special box (self-explanatory) -->
              <div class="modeBox" id="modeBoxNone" hidden>
                <div class="modeBoxTitle">
                  <b>Mode options</b>
                  <span class="mono">No extra settings for this mode</span>
                </div>
                <div class="hint">Use Advanced below if you want avoid-toggles or lane importance adjustments.</div>
              </div>
            </div>

            <div class="hr"></div>

            <!-- =========================================================
                 SECTION: CORE INPUTS (PRESERVED)
            ========================================================= -->
            <div class="row">
              <label style="min-width: 140px;">
                Stress (1–100)
                <input id="stress" type="number" min="1" max="100" step="1" value="25" />
              </label>

              <label style="min-width: 160px;">
                Trailer length (ft)
                <input id="trailerLengthFt" type="number" min="0" max="80" step="0.5" value="16" />
              </label>

              <!-- Mode dropdown preserved (kept in sync with tiles) -->
              <label style="min-width: 170px;">
                Mode
                <select id="mode">
                  <option value="TOW" selected>TOW</option>
                  <option value="LOW_STRESS">LOW_STRESS</option>
                  <option value="FUEL_SAVER">FUEL_SAVER</option>
                  <option value="FASTEST">FASTEST</option>
                </select>
              </label>
            </div>

            <div class="row" style="margin-top:12px;">
              <label style="min-width: 100%; position: relative;">
                Origin (address)
                <input id="origin" type="text" placeholder="Start typing an address…" autocomplete="off" />
                <div class="suggest" id="originSuggest" hidden></div>
              </label>

              <label style="min-width: 100%; position: relative;">
                Destination (address)
                <input id="destination" type="text" placeholder="Start typing an address…" autocomplete="off" />
                <div class="suggest" id="destSuggest" hidden></div>
              </label>
            </div>

            <div class="row" style="margin-top:10px;">
              <button id="planBtn">Plan Route</button>
              <button class="btnGhost" id="swapBtn" type="button">Swap</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btnGhost btnTiny" id="copyReqBtn" type="button">Copy request JSON</button>
              <button class="btnGhost btnTiny" id="copyCurlBtn" type="button">Copy curl</button>
              <button class="btnGhost btnTiny" id="openMapsBtn" type="button">Open in Maps</button>
            </div>

            <div class="hr"></div>

            <!-- =========================================================
                 SECTION: ADVANCED (PRESERVED)
            ========================================================= -->
            <div class="advToggle" id="advToggle">
              <div class="left">
                <div class="t">Advanced</div>
                <div class="d">Avoid options, lane strategy, tow confidence, notes</div>
              </div>
              <div class="pill mono" id="advState">closed</div>
            </div>

            <div class="adv" id="advPanel">
              <div class="row" style="margin-top:12px;">
                <label>
                  Avoid highways
                  <select id="avoidHighways">
                    <option value="false" selected>false</option>
                    <option value="true">true</option>
                  </select>
                </label>

                <label>
                  Avoid tolls
                  <select id="avoidTolls">
                    <option value="false" selected>false</option>
                    <option value="true">true</option>
                  </select>
                </label>

                <label>
                  Avoid ferries
                  <select id="avoidFerries">
                    <option value="false" selected>false</option>
                    <option value="true">true</option>
                  </select>
                </label>

                <label>
                  Avoid unpaved
                  <select id="avoidUnpaved">
                    <option value="false" selected>false</option>
                    <option value="true">true</option>
                  </select>
                </label>

                <label>
                  Lane strategy importance (0–100)
                  <input id="laneImportance" type="number" min="0" max="100" step="1" value="50" />
                </label>

                <label>
                  Tow confidence target (0–100)
                  <input id="towConfidenceTarget" type="number" min="0" max="100" step="1" value="70" />
                </label>

                <label style="min-width: 100%;">
                  Notes
                  <input id="notes" type="text" placeholder="optional" />
                </label>
              </div>
            </div>
          </div>

          <!-- ===================== TAB: HISTORY (PRESERVED) ===================== -->
          <div class="tabPanel" id="tabHistory">
            <div class="row" style="justify-content: space-between;">
              <div class="sub" style="margin:0;">Recent plans (localStorage)</div>
              <button class="btnGhost btnTiny" id="clearHistoryBtn" type="button">Clear history</button>
            </div>
            <div class="hr"></div>
            <div class="history" id="history"></div>
          </div>

          <!-- ===================== TAB: DEVELOPER (PRESERVED) ===================== -->
          <div class="tabPanel" id="tabDev">
            <div class="kv mono" style="margin-bottom:12px;">
              <div>Resolved API:</div><b id="dbgApi">…</b>
              <div>Endpoint:</div><b id="dbgUrl">…</b>
              <div>Last status:</div><b id="dbgStatus">—</b>
              <div>Timing:</div><b id="dbgTiming">—</b>
            </div>

            <div class="sub" style="margin: 6px 0 8px;">Request</div>
            <pre class="mono" id="dbgReq">{}</pre>

            <div class="sub" style="margin: 12px 0 8px;">Response / Error</div>
            <pre class="mono" id="dbgRes">{}</pre>
          </div>

        </div>
      </div>
    </div>
  </div>

<script>
  // =========================================================
  // SECTION: Option C API resolution (PRESERVED)
  // =========================================================
  function resolveApiBase() {
    const params = new URLSearchParams(location.search);

    const override = params.get("api");
    if (override) return override.replace(/\/+$/, "");

    if (location.hostname === "localhost" || location.hostname === "127.0.0.1") {
      return "http://localhost:8080";
    }

    return "https://api.yourdomain.com";
  }

  const API_BASE = resolveApiBase();
  const ENDPOINT = "/v1/route/plan";
  const FULL_URL = API_BASE + ENDPOINT;

  // =========================================================
  // SECTION: DOM helpers (PRESERVED)
  // =========================================================
  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");

  $("apiBasePill").textContent = API_BASE;
  $("dbgApi").textContent = API_BASE;
  $("dbgUrl").textContent = FULL_URL;

  // =========================================================
  // SECTION: Tabs (PRESERVED)
  // =========================================================
  function setActiveTab(tabName) {
    const btns = {
      controls: $("tabControlsBtn"),
      history: $("tabHistoryBtn"),
      dev: $("tabDevBtn")
    };
    const panels = {
      controls: $("tabControls"),
      history: $("tabHistory"),
      dev: $("tabDev")
    };

    Object.keys(btns).forEach(k => btns[k].classList.toggle("active", k === tabName));
    Object.keys(panels).forEach(k => panels[k].classList.toggle("active", k === tabName));
  }

  $("tabControlsBtn").addEventListener("click", () => setActiveTab("controls"));
  $("tabHistoryBtn").addEventListener("click", () => setActiveTab("history"));
  $("tabDevBtn").addEventListener("click", () => setActiveTab("dev"));

  // =========================================================
  // SECTION: HTML escaping (PRESERVED)
  // =========================================================
  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // =========================================================
  // SECTION: Presets (PRESERVED) + Mode tiles drive options box (UPDATED)
  // =========================================================
  const presets = {
    TOW: { mode: "TOW", stress: 25, trailerLengthFt: 16, laneImportance: 60, towConfidenceTarget: 75 },
    LOW_STRESS: { mode: "LOW_STRESS", stress: 15, trailerLengthFt: 0, laneImportance: 75, towConfidenceTarget: 0 },
    FUEL_SAVER: { mode: "FUEL_SAVER", stress: 35, trailerLengthFt: 0, laneImportance: 40, towConfidenceTarget: 0 },
    FASTEST: { mode: "FASTEST", stress: 50, trailerLengthFt: 0, laneImportance: 25, towConfidenceTarget: 0 }
  };

  function setPreset(name, opts={}) {
    const p = presets[name];
    if (!p) return;

    $("mode").value = p.mode;
    $("stress").value = p.stress;
    $("trailerLengthFt").value = p.trailerLengthFt;
    $("laneImportance").value = p.laneImportance;
    $("towConfidenceTarget").value = p.towConfidenceTarget;

    [...document.querySelectorAll(".preset")].forEach(el => {
      el.classList.toggle("active", el.dataset.preset === name);
    });

    // Update mode options box visibility (NEW)
    updateModeOptionsVisibility(p.mode);

    // Update summary stress immediately (additive)
    $("mStress").textContent = String(Number($("stress").value) || "—");

    // Optional: keep current tow selections when clicking Tow; do not overwrite.
    // (No-op here by default)
  }

  $("presetBar").addEventListener("click", (e) => {
    const box = e.target.closest(".preset");
    if (!box) return;
    setPreset(box.dataset.preset);
  });

  // =========================================================
  // SECTION: Mode Options Boxes (NEW)
  // =========================================================
  function updateModeOptionsVisibility(mode) {
    const towBox = $("modeBoxTow");
    const lsBox = $("modeBoxLowStress");
    const noneBox = $("modeBoxNone");

    towBox.hidden = true;
    lsBox.hidden = true;
    noneBox.hidden = true;

    if (mode === "TOW") towBox.hidden = false;
    else if (mode === "LOW_STRESS") lsBox.hidden = false;
    else noneBox.hidden = false;
  }

  // Keep dropdown mode selector in sync with tiles (PRESERVED + UPDATED)
  $("mode").addEventListener("change", () => {
    const m = $("mode").value;

    // Set active tile highlight to match mode
    [...document.querySelectorAll(".preset")].forEach(el => {
      el.classList.toggle("active", el.dataset.preset === m);
    });

    updateModeOptionsVisibility(m);

    // If user manually changes mode, do NOT force-reset all preset defaults.
    // Only update summary stress display.
    $("mStress").textContent = String(Number($("stress").value) || "—");
  });

  // Tow trailer preset sets trailerLengthFt automatically (NEW)
  function applyTowTrailerPreset() {
    const raw = $("towTrailerPreset").value; // e.g. "CAR_HAULER|20"
    const parts = String(raw).split("|");
    const ft = Number(parts[1] || 0);
    if (Number.isFinite(ft)) {
      $("trailerLengthFt").value = ft;
    }
  }
  $("towTrailerPreset").addEventListener("change", applyTowTrailerPreset);

  // Optional: Low Stress driving style can gently adjust laneImportance (additive, not destructive)
  function applyLowStressStyleHints() {
    const style = $("lsDrivingStyle").value;
    // Do not override if user has explicitly chosen something; but we can provide light defaults.
    // Here: only adjust if laneImportance is still at a preset-like value range.
    const li = Number($("laneImportance").value);
    if (!Number.isFinite(li)) return;

    if (style === "CALM" && li < 60) $("laneImportance").value = 75;
    if (style === "NORMAL" && (li < 40 || li > 80)) $("laneImportance").value = 60;
    if (style === "ASSERTIVE" && li > 50) $("laneImportance").value = 40;
  }
  $("lsDrivingStyle").addEventListener("change", applyLowStressStyleHints);

  // Initialize mode box visibility (NEW)
  updateModeOptionsVisibility($("mode").value);

  // =========================================================
  // SECTION: Advanced toggle (PRESERVED)
  // =========================================================
  let advOpen = false;
  $("advToggle").addEventListener("click", () => {
    advOpen = !advOpen;
    $("advPanel").classList.toggle("open", advOpen);
    $("advState").textContent = advOpen ? "open" : "closed";
  });

  // =========================================================
  // SECTION: Map (PRESERVED)
  // =========================================================
  const map = L.map("map", { zoomControl: true }).setView([39.5, -98.35], 4);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  let originMarker = null;
  let destMarker = null;
  let routeLine = null;

  function ensureMarker(existing, latlng, label) {
    if (!latlng) return existing;
    if (!existing) {
      existing = L.marker(latlng).addTo(map).bindPopup(label);
    } else {
      existing.setLatLng(latlng);
    }
    return existing;
  }

  function clearRoute() {
    if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
  }

  function fitToMarkers() {
    const pts = [];
    if (originMarker) pts.push(originMarker.getLatLng());
    if (destMarker) pts.push(destMarker.getLatLng());
    if (pts.length === 2) map.fitBounds(L.latLngBounds(pts), { padding: [30,30] });
    else if (pts.length === 1) map.setView(pts[0], 12);
  }

  function drawGeoJsonLine(coordsLngLat) {
    const latlngs = coordsLngLat.map(([lng, lat]) => [lat, lng]);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(latlngs, { weight: 5, opacity: 0.9 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [30,30] });
  }

  // Polyline decode (PRESERVED)
  function decodePolyline(str) {
    let index = 0, lat = 0, lng = 0, coordinates = [];
    while (index < str.length) {
      let b, shift = 0, result = 0;
      do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
      const dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
      lat += dlat;

      shift = 0; result = 0;
      do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
      const dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
      lng += dlng;

      coordinates.push([lat / 1e5, lng / 1e5]);
    }
    return coordinates;
  }

  function drawPolyline(encoded) {
    const latlngs = decodePolyline(encoded);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(latlngs, { weight: 5, opacity: 0.9 }).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding: [30,30] });
  }

  // =========================================================
  // SECTION: Address autocomplete (PRESERVED + keyboard)
  // =========================================================
  function debounce(fn, ms) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  async function nominatimSearch(q) {
    const url = new URL("https://nominatim.openstreetmap.org/search");
    url.searchParams.set("q", q);
    url.searchParams.set("format", "json");
    url.searchParams.set("addressdetails", "1");
    url.searchParams.set("limit", "8");

    const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error(`Nominatim HTTP ${res.status}`);
    return await res.json();
  }

  function hideSuggest(container) {
    container.hidden = true;
    container.innerHTML = "";
    container.dataset.activeIndex = "-1";
  }

  function renderSuggest(container, items, onPick) {
    container.innerHTML = "";
    container.dataset.activeIndex = "-1";

    if (!items.length) {
      container.hidden = true;
      return;
    }

    items.forEach((it, idx) => {
      const div = document.createElement("div");
      div.className = "suggestItem";
      div.dataset.idx = String(idx);
      div.innerHTML = `
        ${escapeHtml(it.display_name)}
        <span class="suggestSmall">lat ${Number(it.lat).toFixed(5)}, lng ${Number(it.lon).toFixed(5)}</span>
      `;
      div.addEventListener("mousedown", (e) => {
        e.preventDefault();
        onPick(it);
      });
      container.appendChild(div);
    });

    container.hidden = false;
  }

  function setActiveSuggestion(container, index) {
    const items = [...container.querySelectorAll(".suggestItem")];
    items.forEach(el => el.classList.remove("active"));
    if (index >= 0 && index < items.length) {
      items[index].classList.add("active");
      container.dataset.activeIndex = String(index);
      const el = items[index];
      const top = el.offsetTop;
      const bottom = top + el.offsetHeight;
      if (top < container.scrollTop) container.scrollTop = top;
      if (bottom > container.scrollTop + container.clientHeight) container.scrollTop = bottom - container.clientHeight;
    } else {
      container.dataset.activeIndex = "-1";
    }
  }

  const originSuggest = $("originSuggest");
  const destSuggest = $("destSuggest");

  let originChosen = null; // { lat, lng, label }
  let destChosen = null;

  function setChosen(which, v) {
    if (which === "origin") originChosen = v;
    if (which === "dest") destChosen = v;
  }

  function updateMarkersFromChosen() {
    clearRoute();
    if (originChosen) originMarker = ensureMarker(originMarker, [originChosen.lat, originChosen.lng], "Origin");
    if (destChosen) destMarker = ensureMarker(destMarker, [destChosen.lat, destChosen.lng], "Destination");
    fitToMarkers();
  }

  function setupAutocomplete(inputEl, suggestEl, which) {
    let lastResults = [];

    const doSearch = debounce(async () => {
      const q = (inputEl.value || "").trim();
      if (q.length < 3) { hideSuggest(suggestEl); lastResults = []; return; }

      suggestEl.hidden = false;
      suggestEl.style.maxHeight = "280px";
      suggestEl.style.overflow = "auto";
      suggestEl.innerHTML = `<div class="suggestLoading">Searching…</div>`;

      try {
        const results = await nominatimSearch(q);
        lastResults = results || [];
        renderSuggest(suggestEl, lastResults, (pick) => {
          const lat = Number(pick.lat);
          const lng = Number(pick.lon);
          const label = pick.display_name;

          inputEl.value = label;
          setChosen(which, { lat, lng, label });

          hideSuggest(suggestEl);
          updateMarkersFromChosen();
        });
      } catch (e) {
        suggestEl.innerHTML = `<div class="suggestLoading">Lookup failed</div>`;
        setTimeout(() => hideSuggest(suggestEl), 900);
        lastResults = [];
      }
    }, 250);

    inputEl.addEventListener("input", () => {
      setChosen(which, null);
      doSearch();
    });

    inputEl.addEventListener("blur", () => {
      setTimeout(() => hideSuggest(suggestEl), 140);
    });

    inputEl.addEventListener("focus", () => {
      const q = (inputEl.value || "").trim();
      if (q.length >= 3) doSearch();
    });

    inputEl.addEventListener("keydown", (e) => {
      if (suggestEl.hidden) return;

      const items = [...suggestEl.querySelectorAll(".suggestItem")];
      if (!items.length) return;

      const cur = Number(suggestEl.dataset.activeIndex || "-1");

      if (e.key === "ArrowDown") {
        e.preventDefault();
        const next = Math.min(items.length - 1, cur + 1);
        setActiveSuggestion(suggestEl, next);
        return;
      }

      if (e.key === "ArrowUp") {
        e.preventDefault();
        const prev = Math.max(0, cur - 1);
        setActiveSuggestion(suggestEl, prev);
        return;
      }

      if (e.key === "Enter") {
        const idx = Number(suggestEl.dataset.activeIndex || "-1");
        if (idx >= 0 && idx < lastResults.length) {
          e.preventDefault();
          const pick = lastResults[idx];
          const lat = Number(pick.lat);
          const lng = Number(pick.lon);
          const label = pick.display_name;

          inputEl.value = label;
          setChosen(which, { lat, lng, label });

          hideSuggest(suggestEl);
          updateMarkersFromChosen();
        }
        return;
      }

      if (e.key === "Escape") {
        hideSuggest(suggestEl);
      }
    });
  }

  setupAutocomplete($("origin"), originSuggest, "origin");
  setupAutocomplete($("destination"), destSuggest, "dest");

  // =========================================================
  // SECTION: History (PRESERVED)
  // =========================================================
  const HISTORY_KEY = "roadrage_demo_history_v2";

  function loadHistory() {
    try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
    catch { return []; }
  }

  function saveHistory(items) {
    localStorage.setItem(HISTORY_KEY, JSON.stringify(items.slice(0, 10)));
  }

  function nowStamp() {
    const d = new Date();
    return d.toLocaleString();
  }

  function renderHistory() {
    const items = loadHistory();
    const box = $("history");
    box.innerHTML = "";

    if (!items.length) {
      box.innerHTML = `<div class="sub">No history yet.</div>`;
      return;
    }

    for (const it of items) {
      const el = document.createElement("div");
      el.className = "hItem";
      el.innerHTML = `
        <div class="hTop">
          <b class="mono">${escapeHtml(it.mode || "—")} • stress ${it.stress} • trailer ${it.trailerLengthFt}ft</b>
          <span class="mono">${escapeHtml(it.when || "")}</span>
        </div>
        <div class="hMeta mono">
          <span class="pill">HTTP ${escapeHtml(String(it.httpStatus ?? "—"))}</span>
          <span class="pill">${escapeHtml(String(it.ms ?? "—"))}ms</span>
          <span class="pill">${escapeHtml(it.origin || "origin: —")}</span>
          <span class="pill">${escapeHtml(it.destination || "dest: —")}</span>
        </div>
      `;
      box.appendChild(el);
    }
  }

  $("clearHistoryBtn").addEventListener("click", () => {
    localStorage.removeItem(HISTORY_KEY);
    renderHistory();
  });

  function pushHistory(entry) {
    const items = loadHistory();
    items.unshift(entry);
    saveHistory(items);
    renderHistory();
  }

  renderHistory();

  // =========================================================
  // SECTION: Build request payload (PRESERVED + adds mode options)
  // =========================================================
  function buildPayload() {
    const payload = {
      stress: Number($("stress").value),
      trailerLengthFt: Number($("trailerLengthFt").value),
      mode: $("mode").value,
      options: {
        avoidHighways: $("avoidHighways").value === "true",
        avoidTolls: $("avoidTolls").value === "true",
        avoidFerries: $("avoidFerries").value === "true",
        avoidUnpaved: $("avoidUnpaved").value === "true"
      },
      laneStrategy: {
        importance: Number($("laneImportance").value)
      },
      tow: {
        confidenceTarget: Number($("towConfidenceTarget").value)
      },
      notes: ($("notes").value || "").trim()
    };

    // Chosen coords + text (PRESERVED)
    if (originChosen) {
      payload.origin = { lat: originChosen.lat, lng: originChosen.lng, label: originChosen.label };
      payload.originText = originChosen.label;
    } else {
      const t = ($("origin").value || "").trim();
      if (t) payload.originText = t;
    }

    if (destChosen) {
      payload.destination = { lat: destChosen.lat, lng: destChosen.lng, label: destChosen.label };
      payload.destinationText = destChosen.label;
    } else {
      const t = ($("destination").value || "").trim();
      if (t) payload.destinationText = t;
    }

    // NEW: Tow mode options
    if (payload.mode === "TOW") {
      const vehicleClass = $("towVehicleClass").value;
      const trailerRaw = $("towTrailerPreset").value; // "TYPE|FT"
      const parts = String(trailerRaw).split("|");
      const trailerType = parts[0] || "NONE";
      const trailerPresetFt = Number(parts[1] || 0);

      payload.vehicleClass = vehicleClass;            // backend can ignore for now
      payload.towProfile = trailerType;               // backend can ignore for now
      payload.tow = payload.tow || {};
      payload.tow.trailerType = trailerType;          // additive
      payload.tow.trailerPresetFt = trailerPresetFt;  // additive
    }

    // NEW: Low Stress mode options
    if (payload.mode === "LOW_STRESS") {
      payload.lowStress = {
        drivingStyle: $("lsDrivingStyle").value,
        simplicity: $("lsSimplicity").value,
        preferFewerMerges: $("lsPreferFewerMerges").value === "true",
        preferRightLane: $("lsPreferRightLane").value === "true",
        avoidLeftTurns: $("lsAvoidLeftTurns").value === "true",
        avoidComplexInterchanges: $("lsAvoidComplexInterchanges").value === "true"
      };
    }

    return payload;
  }

  function pretty(x) { return JSON.stringify(x, null, 2); }

  // =========================================================
  // SECTION: Copy helpers (PRESERVED)
  // =========================================================
  async function copyText(text) {
    await navigator.clipboard.writeText(text);
    setStatus("Copied", "ok");
    setTimeout(() => setStatus("Ready", null), 900);
  }

  $("copyReqBtn").addEventListener("click", async () => {
    try { await copyText(pretty(buildPayload())); }
    catch { setStatus("Copy blocked", "bad"); }
  });

  $("copyCurlBtn").addEventListener("click", async () => {
    const payload = buildPayload();
    const curl = [
      `curl -X POST "${FULL_URL}"`,
      `  -H "content-type: application/json"`,
      `  -d '${JSON.stringify(payload)}'`
    ].join(" \\\n");
    try { await copyText(curl); }
    catch { setStatus("Copy blocked", "bad"); }
  });

  $("openMapsBtn").addEventListener("click", () => {
    if (!originChosen || !destChosen) {
      setStatus("Pick both addresses", "bad");
      setTimeout(() => setStatus("Ready", null), 1200);
      return;
    }
    const url = `https://www.google.com/maps/dir/?api=1&origin=${originChosen.lat},${originChosen.lng}&destination=${destChosen.lat},${destChosen.lng}`;
    window.open(url, "_blank", "noopener,noreferrer");
  });

  $("swapBtn").addEventListener("click", () => {
    const a = $("origin").value;
    $("origin").value = $("destination").value;
    $("destination").value = a;

    const ao = originChosen;
    originChosen = destChosen;
    destChosen = ao;

    updateMarkersFromChosen();
  });

  // =========================================================
  // SECTION: Status + summary setters (PRESERVED)
  // =========================================================
  function setStatus(text, kind) {
    if (kind === "ok") statusEl.innerHTML = `<span class="ok">${escapeHtml(text)}</span>`;
    else if (kind === "bad") statusEl.innerHTML = `<span class="bad">${escapeHtml(text)}</span>`;
    else if (kind === "warn") statusEl.innerHTML = `<span class="warn">${escapeHtml(text)}</span>`;
    else statusEl.textContent = text;
  }

  function setSummaryFromResponse(body, payload) {
    const eta =
      body?.etaMinutes ??
      body?.route?.etaMinutes ??
      body?.route?.eta_min ??
      body?.route?.durationMinutes ??
      null;

    const dist =
      body?.distanceMiles ??
      body?.route?.distanceMiles ??
      body?.route?.distance_miles ??
      body?.route?.distance ??
      null;

    const stressScore =
      body?.stressScore ??
      body?.route?.stressScore ??
      body?.route?.stress ??
      payload?.stress ??
      null;

    const towRisk =
      body?.towRisk ??
      body?.route?.towRisk ??
      body?.route?.tow_risk ??
      (payload?.mode === "TOW" ? "—" : "n/a");

    $("mEta").textContent = (eta == null) ? "—" : `${eta} min`;
    $("mDist").textContent = (dist == null) ? "—" : (typeof dist === "number" ? `${dist} mi` : String(dist));
    $("mStress").textContent = (stressScore == null) ? "—" : String(stressScore);
    $("mTow").textContent = (towRisk == null) ? "—" : String(towRisk);
  }

  // =========================================================
  // SECTION: Plan route (PRESERVED)
  // =========================================================
  const planBtn = $("planBtn");

  planBtn.addEventListener("click", async () => {
    planBtn.disabled = true;
    setStatus("Requesting…", null);

    const payload = buildPayload();
    $("dbgReq").textContent = pretty(payload);

    const t0 = performance.now();

    try {
      const res = await fetch(FULL_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const ms = Math.round(performance.now() - t0);
      $("dbgTiming").textContent = `${ms}ms`;

      const contentType = (res.headers.get("content-type") || "").toLowerCase();
      const isJson = contentType.includes("application/json");

      const body = isJson ? await res.json() : await res.text();

      $("dbgStatus").textContent = `${res.status} ${res.statusText}`;

      if (!res.ok) {
        const errObj = {
          error: "HTTP_ERROR",
          status: res.status,
          statusText: res.statusText,
          url: FULL_URL,
          response: body
        };
        $("dbgRes").textContent = pretty(errObj);
        setStatus(`HTTP ${res.status}`, "bad");

        pushHistory({
          when: nowStamp(),
          mode: payload.mode,
          stress: payload.stress,
          trailerLengthFt: payload.trailerLengthFt,
          origin: payload.originText || "origin: —",
          destination: payload.destinationText || "dest: —",
          httpStatus: res.status,
          ms
        });

        return;
      }

      $("dbgRes").textContent = isJson ? pretty(body) : String(body);
      setStatus("OK", "ok");

      if (isJson) {
        try { setSummaryFromResponse(body, payload); } catch {}
      } else {
        $("mStress").textContent = String(payload.stress ?? "—");
      }

      try {
        const geo =
          (body && body.route && body.route.geometry) ||
          (body && body.geometry) ||
          null;

        if (geo && geo.type === "LineString" && Array.isArray(geo.coordinates)) {
          drawGeoJsonLine(geo.coordinates);
        } else {
          const pl = (body && body.polyline) || (body && body.route && body.route.polyline) || null;
          if (pl && typeof pl === "string" && pl.length > 10) drawPolyline(pl);
        }
      } catch {}

      updateMarkersFromChosen();

      pushHistory({
        when: nowStamp(),
        mode: payload.mode,
        stress: payload.stress,
        trailerLengthFt: payload.trailerLengthFt,
        origin: payload.originText || "origin: —",
        destination: payload.destinationText || "dest: —",
        httpStatus: 200,
        ms
      });

    } catch (err) {
      const ms = Math.round(performance.now() - t0);
      $("dbgTiming").textContent = `${ms}ms`;
      $("dbgStatus").textContent = "FETCH_FAILED";

      const help = {
        error: "FETCH_FAILED",
        message: String(err && err.message ? err.message : err),
        url: FULL_URL,
        likelyFixes: [
          "If using GitHub Pages: API must be reachable publicly and allow CORS for this origin.",
          "If API is local: ensure backend is running on http://localhost:8080 or use ?api=http://host:port",
          "If page is HTTPS: prefer HTTPS API to avoid mixed-content blocks."
        ]
      };
      $("dbgRes").textContent = pretty(help);
      setStatus("Fetch failed", "bad");

      pushHistory({
        when: nowStamp(),
        mode: payload.mode,
        stress: payload.stress,
        trailerLengthFt: payload.trailerLengthFt,
        origin: payload.originText || "origin: —",
        destination: payload.destinationText || "dest: —",
        httpStatus: "—",
        ms
      });
    } finally {
      planBtn.disabled = false;
      setTimeout(() => setStatus("Ready", null), 1200);
    }
  });

  // =========================================================
  // SECTION: Initialize (PRESERVED)
  // =========================================================
  setPreset("TOW");
  applyTowTrailerPreset();     // ensures trailerLengthFt matches initial tow preset
  $("mStress").textContent = String(Number($("stress").value) || "—");
  $("mTow").textContent = "—";
  $("mEta").textContent = "—";
  $("mDist").textContent = "—";
</script>
</body>
</html>
